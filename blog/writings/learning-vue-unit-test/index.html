<!doctype html><html data-n-head="lang" data-n-head-ssr lang="zh"><meta data-n-head="true" content="IE=edge,chrome=1" http-equiv='"X-UA-Compatible'><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"><meta data-n-head="true" content="bowen blog, bowen 博客, vuejs, reactjs, ssr, 前端开发, 前端 , web开发, nodejs, github" name="keywords"><meta data-n-head="true" content="一个分享代码经历的地方" name="description" data-hid="description"><meta data-n-head="true" content="yes" name="apple-mobile-web-app-capable"><meta data-n-head="true" content="black" name="apple-mobile-web-app-status-bar-style"><meta data-n-head="true" content="yes" name="mobile-web-app-capable" data-hid="mobile-web-app-capable"><meta data-n-head="true" content="Bowen Blog" name="apple-mobile-web-app-title" data-hid="apple-mobile-web-app-title"><meta data-n-head="true" content="Bowen" name="author" data-hid="author"><meta data-n-head="true" content="#24292e" name="theme-color" data-hid="theme-color"><meta data-n-head="true" content="website" name="og:type" data-hid="og:type" property="og:type"><meta data-n-head="true" content="Bowen Blog" name="og:title" data-hid="og:title" property="og:title"><meta data-n-head="true" content="A place which is used to share programming experiences" name="og:description" data-hid="og:description" property="og:description"><title data-n-head="true">总结如何进行单元测试 | Bowen Blog</title><link href="/favicon.ico" rel="icon" data-n-head="true" type="image/x-icon"><link href="/_nuxt/manifest.2108b1d4.json" rel="manifest" data-n-head="true"><link href="/_nuxt/icons/icon_64.e20A200w20w.png" rel="shortcut icon" data-n-head="true"><link href="/_nuxt/icons/icon_512.e20A200w20w.png" rel="apple-touch-icon" data-n-head="true" sizes="512x512"><link href="https://set.sh/blog/writings/learning-vue-unit-test/" rel="alternate" data-n-head="true" hreflang="zh"><link href="/_nuxt/manifest.e871ed9ec943b3b0a9ad.js" rel="preload" as="script"><link href="/_nuxt/vendor.13de21511613edf061b2.js" rel="preload" as="script"><link href="/_nuxt/app.5a4fa6b8fcf73db97515.js" rel="preload" as="script"><link href="/_nuxt/app.7d838d8b0da655541c316320c8ad8e6f.css" rel="preload" as="style"><link href="/_nuxt/layouts/blog.6efcc6c813d476fa30a1.js" rel="preload" as="script"><link href="/_nuxt/pages/blog.48d3a2ec874d58a119ed.js" rel="preload" as="script"><link href="/_nuxt/pages/blog/writings/_id/index.7e8ea086028ccb843111.js" rel="preload" as="script"><link href="/_nuxt/pages/blog/tags/_id/index.edb9dbabb1b9c2ef81f2.js" rel="prefetch"><link href="/_nuxt/pages/index.1d0ac68e309be0e86168.js" rel="prefetch"><link href="/_nuxt/pages/blog/tags/index.2659d358b69abdfd34bf.js" rel="prefetch"><link href="/_nuxt/pages/blog/projects/index.3ff8e031c3cb4f25eaed.js" rel="prefetch"><link href="/_nuxt/pages/blog/writings/index.b016af22016e152b7231.js" rel="prefetch"><link href="/_nuxt/layouts/home.dd55e95df1c2109ebde6.js" rel="prefetch"><link href="/_nuxt/layouts/default.89ffa224d3d7769e4fbb.js" rel="prefetch"><link href="/_nuxt/app.7d838d8b0da655541c316320c8ad8e6f.css" rel="stylesheet"><body data-n-head=""><div id="__nuxt" data-server-rendered="true"><div class="nuxt-progress" style="width:0%;height:2px;background-color:#3eaf7c;opacity:0"></div><div id="__layout"><section class="blog sf__parent__clearfix" data-v-cac63c14><header class="header __position components-animation" data-v-13c46026 data-v-cac63c14><nav class="mobile-navigator" data-v-13c46026 data-v-d4cae7a6><label class="label-line" data-v-d4cae7a6><span class="__position label-line line-top" data-v-d4cae7a6><span class="__position line-crust line-crust-top" data-v-d4cae7a6></span></span><span class="__position label-line line-bottom" data-v-d4cae7a6><span class="__position line-crust line-crust-bottom" data-v-d4cae7a6></span></span></label></nav><nav class="navigator __position grid" data-v-13c46026 role="navigation"><a href="/" class="navigator-link hover-animation grid-cell" data-v-13c46026>HOME</a><a href="/blog/writings/" class="navigator-link hover-animation grid-cell" data-v-13c46026>WRITINGS</a><a href="/blog/projects/" class="navigator-link hover-animation grid-cell" data-v-13c46026>PROJECTS</a><a href="/blog/tags/" class="navigator-link hover-animation grid-cell" data-v-13c46026>TAGS</a><a href="https://github.com/lbwa" class="navigator-link hover-animation grid-cell" data-v-13c46026 rel="noopener" target="_blank">GITHUB</a></nav><div class="background-helper __position" data-v-13c46026></div></header><main class="articles-container wrapper sf__reference__layout" data-v-cac63c14 role="main"><article class="articles-main"><div class="article-header"><h1 class="article-title">总结如何进行单元测试</h1><span class="article-author">Bowen</span><span class="article-date">2018 APR 21</span><div class="article-tags"><a href="/blog/tags/前端开发" class="article-tag">前端开发</a><a href="/blog/tags/vue.js" class="article-tag">Vue.js</a><a href="/blog/tags/应用测试" class="article-tag">应用测试</a></div></div><div class="article-content"><h2 id="关于单元测试应该了解的知识"><a href="#关于单元测试应该了解的知识" class="header-anchor" aria-hidden="true">#</a> 关于单元测试应该了解的知识</h2><h3 id="测试原则"><a href="#测试原则" class="header-anchor" aria-hidden="true">#</a> 测试原则</h3><p>首先最应该搞明白的是，我们要测什么？测试的目的是什么？<p>单元测试，侧重点在"单元"。在单元测试中更应该注重<strong>单个</strong>单文件组件的功能实现，而不是过多纠缠于组件之间的数据传递(这是端到端测试的内容，即 e2e，测试整个应用的功能展现)和组件中的功能实现过程。<p>我们不论是在单元测试中还是 e2e 测试的重点都应该是，测试单个组件（或由多个组件组成的整个应用）的渲染或功能的<strong>结果</strong>，而不是过程！！即侧重<strong>黑盒测试</strong>，至于是怎样实现的，并不是测试的内容。<p>注重结果测试的好处就是，并不限制结果的实现方式，为后期的优化和拓展提供了更多的可能性。<p>比如，测试一个函数的功能，就看这个函数需要什么数据，然后提供测试的原始数据，之后我在调用该函数(可通过直接调用或事件触发)。断言函数的返回结果。这些就是我们的测试内容。至于该函数是如何处理数据的，并不是测试内容。<h3 id="vue-js-单元测试工具箱"><a href="#vue-js-单元测试工具箱" class="header-anchor" aria-hidden="true">#</a> Vue.js 单元测试工具箱</h3><ol><li><a href="https://vue-test-utils.vuejs.org/zh-cn/" rel="noopener noreferrer" target="_blank">vue-test-utils<outboundlink></a>- 官方</ol><ul><li>karma 单元测试环境<li>Mocha 单元测试框架<li><a href="http://www.chaijs.com/guide/styles/#assert" rel="noopener noreferrer" target="_blank">Chai<outboundlink></a>断言库</ul><ol start="2"><li><a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/util.js" rel="noopener noreferrer" target="_blank">ElementFE Vue.js test utils<outboundlink></a></ol><h2 id="单元测试技巧"><a href="#单元测试技巧" class="header-anchor" aria-hidden="true">#</a> 单元测试技巧</h2><h3 id="测试异步行为"><a href="#测试异步行为" class="header-anchor" aria-hidden="true">#</a> 测试异步行为</h3><p>首先需要了解的是 <code>vue-test-utils</code> 是同步应用 DOM 更新的，那么在 <code>Mocha</code> 的 <code>expect()</code> 中存在异步操作且还未完成异步操作时，就可能已经调用 <code>expect()</code> 来断言了。<p>在 <code>Jest</code> 和 <code>Mocha</code> 等单元测试库都定义了一个回调函数 <code>done()</code> 来标明测试用例的完成时机。有了该 <code>done()</code> 回调函数即表明了，该处代码块是异步操作（具体原理见下文）。我们可以和 <code>$nextTick</code> 或 <code>setTimeout</code> 结合 <code>done()</code> 来保证异步操作在断言之前完成。<p><code>done()</code>实际用例：<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/ContentItem.spec.js#L61-L64" rel="noopener noreferrer" target="_blank">用例一<outboundlink></a>，<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/LayoutContent.spec.js#L104-L107" rel="noopener noreferrer" target="_blank">用例二<outboundlink></a><h3 id="测试异步行为的原理"><a href="#测试异步行为的原理" class="header-anchor" aria-hidden="true">#</a> 测试异步行为的原理</h3><p>结论： <code>done()</code> 保证了断言是在下一个事件循环被执行，那么在断言之前的所有异步操作均已完成。<p>在单元测试库中通过一个 <code>done()</code> 回调函数来标明了测试用例的执行时机，其意义在于，只有等到当前事件循环中的所有任务执行（包含了当前事件循环中的所有异步操作的执行）完成后，单元测试库才会调用 <code>done()</code> 回调，用于执行断言。此时的，断言已经开启了新的事件循环队列。<p>之所以，当前事件循环中的异步操作全部被执行的原因是，在一个事件循环中，首先从 marco-task 队列提取第一个任务，在执行这个任务过程中，产生的所有<strong>异步操作</strong>的<strong>回调函数</strong>调用（如，Promise.then()中的参数对象），都将进入 micro-task 队列等待执行。待当前 marco-task 这一任务完成，开始依次执行 micro-task 队列中的任务，直至<strong>清空</strong>该 micro-task 队列。只有等到当前事件循环中的 micro-task 清空后才会进入下一个事件循环，即开启下一个 marco-task 的执行。此时，即是 <code>done()</code> 的执行时机，即正因为有了 <code>done()</code> 才保证了断言是在下一个事件循环中被执行，那么，在此之前的所有异步操作的回调函数早就已经执行完成了。<p>以上原理更多的具体分析，可点击查看我的另一篇博文——<a href="/blog/writings/event-loop/">《理解 event loop 机制》</a>。<h3 id="测试键盘、鼠标及其他-dom-事件"><a href="#测试键盘、鼠标及其他-dom-事件" class="header-anchor" aria-hidden="true">#</a> 测试键盘、鼠标及其他 DOM 事件</h3><p>（以官方单元测试工具为例）<h3 id="测试环境中的事件触发与监听"><a href="#测试环境中的事件触发与监听" class="header-anchor" aria-hidden="true">#</a> 测试环境中的事件触发与监听</h3><pre class="language-js" v-pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'测试点击 todo 单项事件 - refreshThisCompleted'</span><span class="token punctuation">,</span> done <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>ContentItem<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      propsData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> button <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'.toggle'</span><span class="token punctuation">)</span>

    button<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token comment">// 官方库包装了事件触发以及事件的监听的过程</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><code>button.trigger('click')</code> 是官方库的事件触发 API，其包含了事件初始化，事件派发，事件监听等一系列过程。<p>注：在原本的测试环境中 <code>Vue.js</code> 的 watcher 是不能被触发的，其中的 watcher 都是需要手动触发的。<pre class="language-js" v-pre><code><span class="token comment">// 创建事件并触发</span>
<span class="token keyword">const</span> evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>Event</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token comment">// Event() 代替 Document.createEvent() 成为标准</span>
button<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span>
<span class="token comment">// 手动触发 watcher</span>
vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// vm 表示测试环境中的 Vue 实例</span>
</code></pre><p>特别地，特定按键的事件触发如下:<pre class="language-js" v-pre><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'刷新显示的 todo 单项 - refreshItems'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>LayoutContent<span class="token punctuation">)</span>
    <span class="token keyword">const</span> inputBox <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'.add-item'</span><span class="token punctuation">)</span>

    inputBox<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Test content'</span>
    inputBox<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'keyup.enter'</span><span class="token punctuation">)</span> <span class="token comment">// 与 Vue.js 中的特定事件触发写法相似</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>参考：<a href="https://vue-test-utils.vuejs.org/zh-cn/guides/dom-events.html" rel="noopener noreferrer" target="_blank">测试环境中的事件<outboundlink></a><h3 id="测试环境中的-evt-target"><a href="#测试环境中的-evt-target" class="header-anchor" aria-hidden="true">#</a> 测试环境中的 evt.target</h3><p>一般情况下 <code>wrapper.trigger()</code> 可携带一个对象作为载荷，传递给监听器。但是，这个对象<strong>不能</strong>设置事件 evt.target 对象。原因：<a href="https://vue-test-utils.vuejs.org/zh-cn/api/wrapper/trigger.html" rel="noopener noreferrer" target="_blank">点我<outboundlink></a><p>那么在需要取得某个元素的 value 值的情况下，我们可以有以下的实现：<pre class="language-js" v-pre><code><span class="token keyword">const</span> input <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
input<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">100</span>
input<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
</code></pre><p>在调用 <code>trigger()</code> 方法之前就设置好该元素的 value 值。<p>具体使用案例：<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/LayoutContent.spec.js#L38-L50" rel="noopener noreferrer" target="_blank">点我<outboundlink></a><h3 id="重要事项"><a href="#重要事项" class="header-anchor" aria-hidden="true">#</a> 重要事项</h3><p>Vue Test Utils 是同步触发事件。因此 Vue.nextTick 不是必须的。<h2 id="travis-ci"><a href="#travis-ci" class="header-anchor" aria-hidden="true">#</a> travis CI</h2><h3 id="travis-yml-中"><a href="#travis-yml-中" class="header-anchor" aria-hidden="true">#</a> .travis.yml 中</h3><p>在 travis CI 集成时，调用 Chrome 的<a href="https://docs.travis-ci.com/user/chrome" rel="noopener noreferrer" target="_blank">必须选项<outboundlink></a>：<pre class="language-yaml" v-pre><code><span class="token key atrule">sudo</span><span class="token punctuation">:</span> required

<span class="token key atrule">addons</span><span class="token punctuation">:</span>
    <span class="token key atrule">chrome</span><span class="token punctuation">:</span> stable

<span class="token key atrule">before_install</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> export CHROME_BIN=chromium<span class="token punctuation">-</span>browser
  <span class="token punctuation">-</span> export DISPLAY=<span class="token punctuation">:</span><span class="token number">99.0</span>
  <span class="token punctuation">-</span> sh <span class="token punctuation">-</span>e /etc/init.d/xvfb start
</code></pre><p><code>export CHROME_BIN=chromium-browser</code> 表示指定测试时使用的 Chrome 浏览器(最好字指明，还有 <code>google-chrome</code> 可选)。<p>在 <code>karma.conf.js</code> <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" rel="noopener noreferrer" target="_blank">示例配置<outboundlink></a>中调用 <code>Chrome</code> 等<strong>界面浏览器</strong>时，以下两项是***必须项***。<p><code>export DISPLAY=:99.0</code> 指定一个 GUI 测试。<a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs#Ember-Apps" rel="noopener noreferrer" target="_blank">出处<outboundlink></a><p><code>sh -e /etc/init.d/xvfb start</code> 指定一个在 <code>travis CI</code> 中测试时的图形界面。<a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/#Using-xvfb-to-Run-Tests-That-Require-a-GUI" rel="noopener noreferrer" target="_blank">出处<outboundlink></a><p>特别地，在 travis CI 中调用不需要图形界面的 ChromeHeadless 版本（<a href="https://github.com/lbwa/vue-ssr/blob/master/test/unit/karma.conf.js#L19-L23" rel="noopener noreferrer" target="_blank">示例配置<outboundlink></a>）的时候，那么以上两项就***不是必须的***。<h3 id="karma-conf-js-中"><a href="#karma-conf-js-中" class="header-anchor" aria-hidden="true">#</a> karma.conf.js 中</h3><p>在 <code>karma.conf.js</code> <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" rel="noopener noreferrer" target="_blank">示例配置<outboundlink></a>中将部分配置修改如下：<pre class="language-js" v-pre><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">karmaConfig</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// browsers: ['PhantomJS'], 结合 vue-test-utils 挂载时 执行 mount() 会报错</span>
    <span class="token comment">// browsers 数组有多项时，将同时调用数组内的所有浏览器开始 unit test</span>
    browsers<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TRAVIS</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">'Chrome_travis_ci'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 浏览器</span>
    customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      Chrome_travis_ci<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        base<span class="token punctuation">:</span> <span class="token string">'Chrome'</span><span class="token punctuation">,</span>
        <span class="token comment">// https://github.com/karma-runner/karma-chrome-launcher</span>
        flags<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TRAVIS</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
    coverageReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// karma-coverage配置，配置测试覆盖率的输出目录及格式</span>
      dir<span class="token punctuation">:</span> <span class="token string">'./coverage'</span><span class="token punctuation">,</span>
      reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'lcov'</span><span class="token punctuation">,</span> subdir<span class="token punctuation">:</span> <span class="token string">'.'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 输出 Icov.info</span>
        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'text-summary'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 输出 网页报告 Icov-report</span>
        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span> subdir<span class="token punctuation">:</span> <span class="token string">'.'</span> <span class="token punctuation">}</span> <span class="token comment">// 输出 coverage-final.json</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>在配置中使用 <code>process.env.TRAVIS</code> 来判定当前的测试环境，因为在 travis CI 环境中调用 Chrome 时有<a href="https://docs.travis-ci.com/user/chrome" rel="noopener noreferrer" target="_blank">权限的限制<outboundlink></a>，在 travis CI 使用 Chrome 的 <code>--no-sandbox</code> 模式来进行单元测试。<p>另外一种根据不同环境使用 Chrome 的不同模式的<strong>方法</strong>就是，去掉配置中的环境判断，在添加同样的 <code>customLaunchers</code> 配置下，根据 <a href="https://github.com/karma-runner/karma-chrome-launcher" rel="noopener noreferrer" target="_blank">karma-chrome-launcher API<outboundlink></a>来在 node script 添加 CLI 命令以指定测试的浏览器。<pre class="language-bash" v-pre><code>$ cross-env BABEL_ENV<span class="token operator">=</span>test karma start test/unit/karma.conf.js --single-run --browsers Chrome_travis_ci
</code></pre><p>添加 <code>--browsers Chrome_travis_ci</code> 来指定在 travis CI 中的浏览器，因为我们在 <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" rel="noopener noreferrer" target="_blank">karma.conf.js<outboundlink></a>中定义了 <code>customLaunchers</code> ，那么此时启动的<strong>浏览器及其模式</strong>将会<strong>匹配</strong>我们定义的 <code>customLaunchers</code> 项。<h2 id="参考"><a href="#参考" class="header-anchor" aria-hidden="true">#</a> 参考</h2><p><a href="https://vue-test-utils.vuejs.org/zh-cn/guides/common-tips.html" rel="noopener noreferrer" target="_blank">vue-test-utils 高级技巧<outboundlink></a><p><a href="http://slides.com/mattoconnell/deck#/" rel="noopener noreferrer" target="_blank">Matt O'Connell 关于 Vue.js 的单元测试的演讲<outboundlink></a><p><a href="https://swizec.com/blog/how-to-run-javascript-tests-in-chrome-on-travis/swizec/6647" rel="noopener noreferrer" target="_blank">How to run JavaScript tests in Chrome on Travis<outboundlink></a><p><a href="https://docs.travis-ci.com/user/environment-variables/#Default-Environment-Variables" rel="noopener noreferrer" target="_blank">travis CI 默认环境变量<outboundlink></a></div></article><button data-v-e85d20b2 data-v-e85d20b2 class="floating-btn __position" style="display:none"><svg class="icon-rocket" data-v-e85d20b2 viewBox="0 0 512 512"><path d="M256 421.6c-18.1 0-33.2-6.8-42.9-10.9-5.4-2.3-11.3 1.8-10.9 7.6l3.5 51c.2 3.1 3.8 4.7 6.3 2.8l14.5-11c1.8-1.4 4.5-.9 5.7 1l20.5 32.1c1.5 2.4 5.1 2.4 6.6 0l20.5-32.1c1.2-1.9 3.9-2.4 5.7-1l14.5 11c2.5 1.9 6.1.3 6.3-2.8l3.5-51c.4-5.8-5.5-10-10.9-7.6-9.8 4.1-24.8 10.9-42.9 10.9z" data-v-e85d20b2></path><path d="M397.7 293.1l-48-49.1c0-158-93.2-228-93.2-228s-94.1 70-94.1 228l-48 49.1c-1.8 1.8-2.6 4.5-2.2 7.1L130.6 412c.9 5.7 7.1 8.5 11.8 5.4l67.1-45.4s20.7 20 47.1 20c26.4 0 46.1-20 46.1-20l67.1 45.4c4.6 3.1 10.8.3 11.8-5.4l18.5-111.9c.2-2.6-.6-5.2-2.4-7zM256.5 192c-17 0-30.7-14.3-30.7-32s13.8-32 30.7-32c17 0 30.7 14.3 30.7 32s-13.7 32-30.7 32z" data-v-e85d20b2></path></svg></button></main><footer class="blog-footer sf__main__layout grid col grid-jc-center" data-v-1044ad0a data-v-cac63c14><div class="footer-info" data-v-1044ad0a>Copyright © 2018 <a href="https://github.com/lbwa" class="author" rel="noopener" target="_blank" data-v-1044ad0a>Bowen</a></div></footer><section class="loading-wrapper grid col grid-center grid-jc-center" data-v-cac63c14 style="display:none"><div class="loading"><div class="loading-item"></div><div class="loading-item"></div><div class="loading-item"></div><div class="loading-item"></div><div class="loading-item"></div></div><a class="loading-tips">Loading</a></section></section></div></div><script type="text/javascript">window.__NUXT__={layout:"blog",data:[{menu:[{errno:0,to:"writings/dom-location",title:"获取 Element 在 document 中的位置信息",author:"Bowen",date:"2018 SEP 01",tags:["前端开发","CSS"]},{errno:0,to:"writings/spa-and-mpa",title:"SPA 与 MPA 的比较与优化",author:"Bowen",date:"2018 AUG 04",tags:["前端开发","SPA","MPA","skeleton"]},{errno:0,to:"writings/async-function-in-js",title:"Event loops 中的 AsyncFunction",author:"Bowen",date:"2018 JUL 26",tags:["JavaScript","async","事件循环"]},{errno:0,to:"writings/pwa-fundamentals",title:"PWA 基础",author:"Bowen",date:"2018 JUL 07",tags:["前端开发","PWA"]},{errno:0,to:"writings/js-design-pattern",title:"JS 设计模式",author:"Bowen",date:"2018 JUN 12",tags:["前端开发","设计模式"]},{errno:0,to:"writings/http-request",title:"HTTP 协议请求首部",author:"Bowen",date:"2018 JUN 08",tags:["前端开发","网络请求"]},{errno:0,to:"writings/http-response",title:"HTTP 协议响应首部",author:"Bowen",date:"2018 JUN 07",tags:["前端开发","网络请求"]},{errno:0,to:"writings/http-protocol",title:"HTTP 协议",author:"Bowen",date:"2018 JUN 06",tags:["前端开发","网络请求"]},{errno:0,to:"writings/execution-context",title:"JS 执行上下文",author:"Bowen",date:"2018 MAY 07",tags:["前端开发","JavaScript","执行上下文"]},{errno:0,to:"writings/vue-lifecycle-and-slots",title:"对 Vue 插槽和生命周期的一点思考",author:"Bowen",date:"2018 APR 24",tags:["前端开发","Vue.js"]},{errno:0,to:"writings/learning-vue-unit-test",title:"总结如何进行单元测试",author:"Bowen",date:"2018 APR 21",tags:["前端开发","Vue.js","应用测试"]},{errno:0,to:"writings/cross-domain-solution",title:"客户端跨域解决方案",author:"Bowen",date:"2018 APR 19",tags:["前端开发","网络请求"]},{errno:0,to:"writings/css-bfc",title:"探究 BFC 以及闭合浮动原理",author:"Bowen",date:"2018 MAR 29",tags:["前端开发","CSS"]},{errno:0,to:"writings/vue.js-reusability-and-composition",title:"学习 Vue.js 可复用性和组合",author:"Bowen",date:"2018 MAR 12",tags:["前端开发","JavaScript","Vue.js"]},{errno:0,to:"writings/event-loop",title:"解析 event loops",author:"Bowen",date:"2018 MAR 08",tags:["前端开发","JavaScript","事件循环"]},{errno:0,to:"writings/learning-vuex",title:"学习 vuex 基础",author:"Bowen",date:"2018 MAR 06",tags:["前端开发","Vue.js"]},{errno:0,to:"writings/compare-commonjs-with-esm",title:"比较 CommonJS 与 ES6 Module 语法",author:"Bowen",date:"2018 FEB 27",tags:["前端开发","JavaScript","模块"]},{errno:0,to:"writings/learning-vuejs-essentials",title:"学习 Vue.js 基础",author:"Bowen",date:"2018 FEB 24",tags:["前端开发","JavaScript","Vue.js"]},{errno:0,to:"writings/keyword-this",title:"理解 this 的指向",author:"Bowen",date:"2018 FEB 06",tags:["前端开发","JavaScript"]}]},{title:"总结如何进行单元测试",date:"2018 APR 21",author:"Bowen",tags:["前端开发","Vue.js","应用测试"],content:'<h2 id="关于单元测试应该了解的知识"><a class="header-anchor" href="#关于单元测试应该了解的知识" aria-hidden="true">#</a> 关于单元测试应该了解的知识</h2>\n<h3 id="测试原则"><a class="header-anchor" href="#测试原则" aria-hidden="true">#</a> 测试原则</h3>\n<p>首先最应该搞明白的是，我们要测什么？测试的目的是什么？</p>\n<p>单元测试，侧重点在&quot;单元&quot;。在单元测试中更应该注重<strong>单个</strong>单文件组件的功能实现，而不是过多纠缠于组件之间的数据传递(这是端到端测试的内容，即 e2e，测试整个应用的功能展现)和组件中的功能实现过程。</p>\n<p>我们不论是在单元测试中还是 e2e 测试的重点都应该是，测试单个组件（或由多个组件组成的整个应用）的渲染或功能的<strong>结果</strong>，而不是过程！！即侧重<strong>黑盒测试</strong>，至于是怎样实现的，并不是测试的内容。</p>\n<p>注重结果测试的好处就是，并不限制结果的实现方式，为后期的优化和拓展提供了更多的可能性。</p>\n<p>比如，测试一个函数的功能，就看这个函数需要什么数据，然后提供测试的原始数据，之后我在调用该函数(可通过直接调用或事件触发)。断言函数的返回结果。这些就是我们的测试内容。至于该函数是如何处理数据的，并不是测试内容。</p>\n<h3 id="vue-js-单元测试工具箱"><a class="header-anchor" href="#vue-js-单元测试工具箱" aria-hidden="true">#</a> Vue.js 单元测试工具箱</h3>\n<ol>\n<li><a href="https://vue-test-utils.vuejs.org/zh-cn/" target="_blank" rel="noopener noreferrer">vue-test-utils<OutboundLink/></a> - 官方</li>\n</ol>\n<ul>\n<li>karma 单元测试环境</li>\n<li>Mocha 单元测试框架</li>\n<li><a href="http://www.chaijs.com/guide/styles/#assert" target="_blank" rel="noopener noreferrer">Chai<OutboundLink/></a> 断言库</li>\n</ul>\n<ol start="2">\n<li><a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/util.js" target="_blank" rel="noopener noreferrer">ElementFE Vue.js test utils<OutboundLink/></a></li>\n</ol>\n<h2 id="单元测试技巧"><a class="header-anchor" href="#单元测试技巧" aria-hidden="true">#</a> 单元测试技巧</h2>\n<h3 id="测试异步行为"><a class="header-anchor" href="#测试异步行为" aria-hidden="true">#</a> 测试异步行为</h3>\n<p>首先需要了解的是 <code>vue-test-utils</code> 是同步应用 DOM 更新的，那么在 <code>Mocha</code> 的 <code>expect()</code> 中存在异步操作且还未完成异步操作时，就可能已经调用 <code>expect()</code> 来断言了。</p>\n<p>在 <code>Jest</code> 和 <code>Mocha</code> 等单元测试库都定义了一个回调函数 <code>done()</code> 来标明测试用例的完成时机。有了该 <code>done()</code> 回调函数即表明了，该处代码块是异步操作（具体原理见下文）。我们可以和 <code>$nextTick</code> 或 <code>setTimeout</code> 结合 <code>done()</code> 来保证异步操作在断言之前完成。</p>\n<p><code>done()</code>实际用例：<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/ContentItem.spec.js#L61-L64" target="_blank" rel="noopener noreferrer">用例一<OutboundLink/></a>，<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/LayoutContent.spec.js#L104-L107" target="_blank" rel="noopener noreferrer">用例二<OutboundLink/></a></p>\n<h3 id="测试异步行为的原理"><a class="header-anchor" href="#测试异步行为的原理" aria-hidden="true">#</a> 测试异步行为的原理</h3>\n<p>结论： <code>done()</code> 保证了断言是在下一个事件循环被执行，那么在断言之前的所有异步操作均已完成。</p>\n<p>在单元测试库中通过一个 <code>done()</code> 回调函数来标明了测试用例的执行时机，其意义在于，只有等到当前事件循环中的所有任务执行（包含了当前事件循环中的所有异步操作的执行）完成后，单元测试库才会调用 <code>done()</code> 回调，用于执行断言。此时的，断言已经开启了新的事件循环队列。</p>\n<p>之所以，当前事件循环中的异步操作全部被执行的原因是，在一个事件循环中，首先从 marco-task 队列提取第一个任务，在执行这个任务过程中，产生的所有<strong>异步操作</strong>的<strong>回调函数</strong>调用（如，Promise.then()中的参数对象），都将进入 micro-task 队列等待执行。待当前 marco-task 这一任务完成，开始依次执行 micro-task 队列中的任务，直至<strong>清空</strong>该 micro-task 队列。只有等到当前事件循环中的 micro-task 清空后才会进入下一个事件循环，即开启下一个 marco-task 的执行。此时，即是 <code>done()</code> 的执行时机，即正因为有了 <code>done()</code> 才保证了断言是在下一个事件循环中被执行，那么，在此之前的所有异步操作的回调函数早就已经执行完成了。</p>\n<p>以上原理更多的具体分析，可点击查看我的另一篇博文——<a href="/blog/writings/event-loop/">《理解 event loop 机制》</a>。</p>\n<h3 id="测试键盘、鼠标及其他-dom-事件"><a class="header-anchor" href="#测试键盘、鼠标及其他-dom-事件" aria-hidden="true">#</a> 测试键盘、鼠标及其他 DOM 事件</h3>\n<p>（以官方单元测试工具为例）</p>\n<h3 id="测试环境中的事件触发与监听"><a class="header-anchor" href="#测试环境中的事件触发与监听" aria-hidden="true">#</a> 测试环境中的事件触发与监听</h3>\n<pre v-pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">\'测试点击 todo 单项事件 - refreshThisCompleted\'</span><span class="token punctuation">,</span> done <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>ContentItem<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      propsData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n       <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> button <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">\'.toggle\'</span><span class="token punctuation">)</span>\n\n    button<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">)</span> <span class="token comment">// 官方库包装了事件触发以及事件的监听的过程</span>\n\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<p><code>button.trigger(\'click\')</code> 是官方库的事件触发 API，其包含了事件初始化，事件派发，事件监听等一系列过程。</p>\n<p>注：在原本的测试环境中 <code>Vue.js</code> 的 watcher 是不能被触发的，其中的 watcher 都是需要手动触发的。</p>\n<pre v-pre class="language-js"><code><span class="token comment">// 创建事件并触发</span>\n<span class="token keyword">const</span> evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>Event</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">)</span> <span class="token comment">// Event() 代替 Document.createEvent() 成为标准</span>\nbutton<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span>\n<span class="token comment">// 手动触发 watcher</span>\nvm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// vm 表示测试环境中的 Vue 实例</span>\n</code></pre>\n<p>特别地，特定按键的事件触发如下:</p>\n<pre v-pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">\'刷新显示的 todo 单项 - refreshItems\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>LayoutContent<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> inputBox <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">\'.add-item\'</span><span class="token punctuation">)</span>\n\n    inputBox<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">\'Test content\'</span>\n    inputBox<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">\'keyup.enter\'</span><span class="token punctuation">)</span> <span class="token comment">// 与 Vue.js 中的特定事件触发写法相似</span>\n    <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre>\n<p>参考：<a href="https://vue-test-utils.vuejs.org/zh-cn/guides/dom-events.html" target="_blank" rel="noopener noreferrer">测试环境中的事件<OutboundLink/></a></p>\n<h3 id="测试环境中的-evt-target"><a class="header-anchor" href="#测试环境中的-evt-target" aria-hidden="true">#</a> 测试环境中的 evt.target</h3>\n<p>一般情况下 <code>wrapper.trigger()</code> 可携带一个对象作为载荷，传递给监听器。但是，这个对象<strong>不能</strong>设置事件 evt.target 对象。原因：<a href="https://vue-test-utils.vuejs.org/zh-cn/api/wrapper/trigger.html" target="_blank" rel="noopener noreferrer">点我<OutboundLink/></a></p>\n<p>那么在需要取得某个元素的 value 值的情况下，我们可以有以下的实现：</p>\n<pre v-pre class="language-js"><code><span class="token keyword">const</span> input <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">\'input\'</span><span class="token punctuation">)</span>\ninput<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">100</span>\ninput<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">)</span>\n</code></pre>\n<p>在调用 <code>trigger()</code> 方法之前就设置好该元素的 value 值。</p>\n<p>具体使用案例：<a href="https://github.com/lbwa/vue-unit-test/blob/3fcee440f0e0511071d8f559b54b88ab23197904/test/unit/specs/LayoutContent.spec.js#L38-L50" target="_blank" rel="noopener noreferrer">点我<OutboundLink/></a></p>\n<h3 id="重要事项"><a class="header-anchor" href="#重要事项" aria-hidden="true">#</a> 重要事项</h3>\n<p>Vue Test Utils 是同步触发事件。因此 Vue.nextTick 不是必须的。</p>\n<h2 id="travis-ci"><a class="header-anchor" href="#travis-ci" aria-hidden="true">#</a> travis CI</h2>\n<h3 id="travis-yml-中"><a class="header-anchor" href="#travis-yml-中" aria-hidden="true">#</a> .travis.yml 中</h3>\n<p>在 travis CI 集成时，调用 Chrome 的<a href="https://docs.travis-ci.com/user/chrome" target="_blank" rel="noopener noreferrer">必须选项<OutboundLink/></a>：</p>\n<pre v-pre class="language-yaml"><code><span class="token key atrule">sudo</span><span class="token punctuation">:</span> required\n\n<span class="token key atrule">addons</span><span class="token punctuation">:</span>\n    <span class="token key atrule">chrome</span><span class="token punctuation">:</span> stable\n\n<span class="token key atrule">before_install</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> export CHROME_BIN=chromium<span class="token punctuation">-</span>browser\n  <span class="token punctuation">-</span> export DISPLAY=<span class="token punctuation">:</span><span class="token number">99.0</span>\n  <span class="token punctuation">-</span> sh <span class="token punctuation">-</span>e /etc/init.d/xvfb start\n</code></pre>\n<p><code>export CHROME_BIN=chromium-browser</code> 表示指定测试时使用的 Chrome 浏览器(最好字指明，还有 <code>google-chrome</code> 可选)。</p>\n<p>在 <code>karma.conf.js</code> <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" target="_blank" rel="noopener noreferrer">示例配置<OutboundLink/></a>中调用 <code>Chrome</code> 等<strong>界面浏览器</strong>时，以下两项是***必须项***。</p>\n<p><code>export DISPLAY=:99.0</code> 指定一个 GUI 测试。<a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs#Ember-Apps" target="_blank" rel="noopener noreferrer">出处<OutboundLink/></a></p>\n<p><code>sh -e /etc/init.d/xvfb start</code> 指定一个在 <code>travis CI</code> 中测试时的图形界面。<a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/#Using-xvfb-to-Run-Tests-That-Require-a-GUI" target="_blank" rel="noopener noreferrer">出处<OutboundLink/></a></p>\n<p>特别地，在 travis CI 中调用不需要图形界面的 ChromeHeadless 版本（<a href="https://github.com/lbwa/vue-ssr/blob/master/test/unit/karma.conf.js#L19-L23" target="_blank" rel="noopener noreferrer">示例配置<OutboundLink/></a>）的时候，那么以上两项就***不是必须的***。</p>\n<h3 id="karma-conf-js-中"><a class="header-anchor" href="#karma-conf-js-中" aria-hidden="true">#</a> karma.conf.js 中</h3>\n<p>在 <code>karma.conf.js</code> <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" target="_blank" rel="noopener noreferrer">示例配置<OutboundLink/></a>中将部分配置修改如下：</p>\n<pre v-pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">karmaConfig</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  config<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// browsers: [\'PhantomJS\'], 结合 vue-test-utils 挂载时 执行 mount() 会报错</span>\n    <span class="token comment">// browsers 数组有多项时，将同时调用数组内的所有浏览器开始 unit test</span>\n    browsers<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TRAVIS</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">\'Chrome_travis_ci\'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'Chrome\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 浏览器</span>\n    customLaunchers<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      Chrome_travis_ci<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        base<span class="token punctuation">:</span> <span class="token string">\'Chrome\'</span><span class="token punctuation">,</span>\n        <span class="token comment">// https://github.com/karma-runner/karma-chrome-launcher</span>\n        flags<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TRAVIS</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">\'--no-sandbox\'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// ...</span>\n    coverageReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// karma-coverage配置，配置测试覆盖率的输出目录及格式</span>\n      dir<span class="token punctuation">:</span> <span class="token string">\'./coverage\'</span><span class="token punctuation">,</span>\n      reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'lcov\'</span><span class="token punctuation">,</span> subdir<span class="token punctuation">:</span> <span class="token string">\'.\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 输出 Icov.info</span>\n        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'text-summary\'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 输出 网页报告 Icov-report</span>\n        <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'json\'</span><span class="token punctuation">,</span> subdir<span class="token punctuation">:</span> <span class="token string">\'.\'</span> <span class="token punctuation">}</span> <span class="token comment">// 输出 coverage-final.json</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre>\n<p>在配置中使用 <code>process.env.TRAVIS</code> 来判定当前的测试环境，因为在 travis CI 环境中调用 Chrome 时有<a href="https://docs.travis-ci.com/user/chrome" target="_blank" rel="noopener noreferrer">权限的限制<OutboundLink/></a>，在 travis CI 使用 Chrome 的 <code>--no-sandbox</code> 模式来进行单元测试。</p>\n<p>另外一种根据不同环境使用 Chrome 的不同模式的<strong>方法</strong>就是，去掉配置中的环境判断，在添加同样的 <code>customLaunchers</code> 配置下，根据 <a href="https://github.com/karma-runner/karma-chrome-launcher" target="_blank" rel="noopener noreferrer">karma-chrome-launcher API<OutboundLink/></a> 来在 node script 添加 CLI 命令以指定测试的浏览器。</p>\n<pre v-pre class="language-bash"><code>$ cross-env BABEL_ENV<span class="token operator">=</span>test karma start test/unit/karma.conf.js --single-run --browsers Chrome_travis_ci\n</code></pre>\n<p>添加 <code>--browsers Chrome_travis_ci</code> 来指定在 travis CI 中的浏览器，因为我们在 <a href="https://github.com/lbwa/vue-unit-test/blob/master/test/unit/karma.conf.js" target="_blank" rel="noopener noreferrer">karma.conf.js<OutboundLink/></a> 中定义了 <code>customLaunchers</code> ，那么此时启动的<strong>浏览器及其模式</strong>将会<strong>匹配</strong>我们定义的 <code>customLaunchers</code> 项。</p>\n<h2 id="参考"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2>\n<p><a href="https://vue-test-utils.vuejs.org/zh-cn/guides/common-tips.html" target="_blank" rel="noopener noreferrer">vue-test-utils 高级技巧<OutboundLink/></a></p>\n<p><a href="http://slides.com/mattoconnell/deck#/" target="_blank" rel="noopener noreferrer">Matt O\'Connell 关于 Vue.js 的单元测试的演讲<OutboundLink/></a></p>\n<p><a href="https://swizec.com/blog/how-to-run-javascript-tests-in-chrome-on-travis/swizec/6647" target="_blank" rel="noopener noreferrer">How to run JavaScript tests in Chrome on Travis<OutboundLink/></a></p>\n<p><a href="https://docs.travis-ci.com/user/environment-variables/#Default-Environment-Variables" target="_blank" rel="noopener noreferrer">travis CI 默认环境变量<OutboundLink/></a></p>\n'}],error:null,serverRendered:!0}</script><script defer src="/_nuxt/manifest.e871ed9ec943b3b0a9ad.js"></script><script defer src="/_nuxt/layouts/blog.6efcc6c813d476fa30a1.js"></script><script defer src="/_nuxt/pages/blog.48d3a2ec874d58a119ed.js"></script><script defer src="/_nuxt/pages/blog/writings/_id/index.7e8ea086028ccb843111.js"></script><script defer src="/_nuxt/vendor.13de21511613edf061b2.js"></script><script defer src="/_nuxt/app.5a4fa6b8fcf73db97515.js"></script>